<html>
	<head>
		<title>Hubway Routes</title>
		<script type="text/javascript" src = "underscore-min.js"></script>
		<script type="text/javascript" src = "backbone-min.js"></script>
		<script type="text/javascript" src = "d3/d3.v2.js"></script>
		<style type="text/css">
			body {
				font-family:"helvetica neue","helvetica",sans-serif;
				font-size:0.8em;
			}
			
			.container svg {
			
				
			}
			
		</style>
	</head>
	<body>
		<h1>Hubway Bike Race!!!!!</h1>
		<script type="text/javascript">
			
			// based on mike bostock's https://gist.github.com/1584697
		
			var sort = false;
			
			setInterval(function() {
			
				/*
			  if (sort = !sort) {
				index.sort(function(a, b) { return data[a] - data[b]; });
			  } else {
				index = d3.range(24);
			  }
			
			  y.domain(index);
			
			  bar.transition()
				  .duration(750)
				  .delay(function(d, i) { return i * 50; })
				  .attr("transform", function(d, i) { return "translate(0," + y(i) + ")"; });
				*/
			}, 5000);
			
			// global variables like this is probably not the right way
			var data;
			var svg;
			var x;
			var y;
			var margin;
			var width;
			var height;
			
			// Load the route data from CSV
			d3.csv('bikedaily.csv', function(rows) {
				
				//data = rows;
				
				// collect the data into groups by station
				
				bikes = _.groupBy(rows,function(row){return row.bike_nr;})
		
				data = d3.entries(bikes)
		
				// set up chart area
				margin = {top: 0, right: 10, bottom: 20, left: 10},
					width = 960 - margin.left - margin.right,
					height = 10000 - margin.top - margin.bottom;
					
				svg = d3.select("body").append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom)
				  .append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
					
				// set up the scales based on the data
				x = d3.scale.linear()
					.domain([0, 1200])  // should probably change this to something dependent on the data
					.range([0, width]);
				
				y = d3.scale.ordinal()
					.domain(d3.range(data.length))
					.rangeBands([0, height], .1);
				
				// start the process of displaying the graphics
				// graph the bars
				//graphBars("2012-09-15")
				
				dateIterate(data)

			})
			
			
			var bikedates;
			
			// graph (or update) the bars for a given data set
			function dateIterate(data) {
			
				/* extract the unique dates from all values */
				
				// pluck out an array of dates for each bike
				datearrays = _(data).map(function(datum){return _.pluck(datum.value,'date');})
				
				// flatten, sort, and unique the resulting data Array
				// in the future, would be better to just have this and not calculate it, because it's expensive
				bikedates = _.sortBy(_.flatten(datearrays),function(datevalue) {return datevalue;})
				bikedates = _.uniq(bikedates,true)	// unique the values - pass true to tell it that it's already sorted
				
				// call the graph function for each date in sequence
				
				
				_.each(bikedates,function(date) {
				
						graphBars(data,date);
						console.log("ok!");
					});
				
				/*
				for (var i=0; i < bikedates.length; i++) {
				
					graphBars(data,bikedates[i]);
					console.log("ok!");
				}
				*/
				//graphBars(bikedates[0])
				
			}
		
			
			/* create a function that graphs bars for a given date and transitions */
				
			function graphBars(data,dateString) {
			
				// now need to get this to graph the bars based on the input date string
				// for now only graph the bars that have a value for the given date
				
				// find the given date value
				
				var bar = svg.selectAll(".bar")
					.data(data)
				  .enter().append("g")
					.attr("class", "bar")
					.attr("transform", function(d, i) { return "translate(0," + y(i) + ")"; });
				
				// this adds the actual bar area
				// find the appropriate value for the dateitem.
				bar.append("rect")
					.attr("height", y.rangeBand())
					//.attr("width", function(d,i) {return x(d.value[0]['distance'])}); // need to take out this 10
					.attr("width", function(d,i) {
					
								thing = _.find(d.value, function(datapoint) {return datapoint['date'] == dateString;})
								if (thing) {
									return x(
											thing['cum_dist']
										)
								}
								else {
									return 0
								}
						});
					
				// this adds the text labels
				bar.append("text")
					.attr("text-anchor", "end")
					.attr("x", function(d) { return x(d) - 6; })
					.attr("y", y.rangeBand() / 2)
					.attr("dy", ".35em")
					.text(function(d, i) { return i; });
				
				// this is the axis
				svg.append("g")  // appends a new group element
					.attr("class", "x axis")
					.attr("transform", "translate(0," + height + ")")
					.call(d3.svg.axis()
					.scale(x)
					.orient("bottom"));
			
			}
			
		</script>
	</body>
</html>